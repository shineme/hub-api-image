# 实现计划

- [x] 1. 创建核心类型定义和接口
  - 创建 `types/tokenTypes.ts` 文件定义所有令牌相关类型
  - 定义 `HFToken`, `TokenStats`, `FailureReason`, `ErrorCode` 等接口
  - 定义 `TokenPoolStorage`, `TokenStatsStorage`, `HFSettings` 存储接口
  - _需求: 1.2, 2.1, 3.1, 6.1_

- [x] 2. 实现 Token Manager 核心功能
  - 创建 `services/tokenManager.ts` 文件
  - 实现令牌池的初始化和 localStorage 加载
  - 实现 `addToken`, `removeToken`, `updateToken` 方法
  - 实现 `getTokens` 方法返回所有令牌
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 2.1 编写 Token Manager 基础功能的属性测试
  - **属性 8: 令牌格式验证**
  - **验证: 需求 1.2**

- [x] 3. 实现令牌轮询逻辑
  - 在 `tokenManager.ts` 中实现 `getNextToken` 方法
  - 实现轮询队列管理(取出后移到队列尾部)
  - 跳过被临时禁用的令牌
  - 处理空令牌池情况(返回 null)
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 3.1 编写令牌轮询的属性测试
  - **属性 1: 令牌轮询一致性**
  - **验证: 需求 2.1, 2.2, 2.3**

- [x] 4. 实现令牌状态管理和故障转移
  - 实现 `markTokenSuccess` 方法重置失败计数
  - 实现 `markTokenFailure` 方法处理失败场景
  - 实现临时禁用逻辑(连续失败 3 次禁用 5 分钟)
  - 实现令牌状态持久化到 localStorage
  - _需求: 3.1, 3.2, 3.4, 3.5_

- [x] 4.1 编写故障转移的属性测试
  - **属性 2: 故障转移完整性**
  - **验证: 需求 3.1, 3.2, 3.3**

- [x] 4.2 编写令牌禁用恢复的属性测试
  - **属性 3: 令牌禁用恢复**
  - **验证: 需求 3.5**

- [x] 4.3 编写令牌状态持久化的属性测试
  - **属性 4: 令牌状态持久化**
  - **验证: 需求 6.5**

- [x] 5. 实现令牌统计功能
  - 实现 `getTokenStats` 方法返回单个令牌统计
  - 实现 `getAllTokenStats` 方法返回所有令牌统计
  - 实现 `resetTokenStats` 方法重置统计数据
  - 在令牌使用时更新统计信息(使用次数、成功次数、失败次数、最后使用时间)
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 6. 创建 API Client 基础设施
  - 创建 `services/apiClient.ts` 文件
  - 实现 `APIClient` 类的基础结构
  - 实现 `request` 方法处理 HTTP 请求
  - 实现 `setToken` 方法设置认证令牌
  - 添加请求超时控制(默认 30 秒)
  - _需求: 7.1, 7.2_

- [x] 6.1 编写超时保护的属性测试
  - **属性 7: 超时保护**
  - **验证: 需求 7.1**

- [x] 7. 实现 API Client 错误处理
  - 实现错误分类逻辑(认证错误、配额错误、网络错误、服务器错误)
  - 创建 `APIError` 类和错误代码枚举
  - 实现不同错误类型的处理策略
  - 记录响应时间用于性能监控
  - _需求: 3.1, 3.2, 7.2, 7.3, 7.5_

- [x] 8. 重构现有 Image Generation Service
  - 修改 `services/hfService.ts` 中的 `generateImage` 函数
  - 集成 Token Manager 获取令牌
  - 实现故障转移逻辑(调用失败时获取下一个令牌)
  - 实现重试次数限制(不超过令牌池大小)
  - 保持向后兼容(支持空令牌池使用公共配额)
  - _需求: 2.1, 3.1, 3.2, 3.3, 7.4_

- [x] 8.1 编写重试次数限制的属性测试
  - **属性 6: 重试次数限制**
  - **验证: 需求 7.4**

- [x] 8.2 编写空令牌池降级的属性测试
  - **属性 9: 空令牌池降级**
  - **验证: 需求 1.5**

- [x] 9. 实现参数验证
  - 在 `generateImage` 函数中添加参数验证
  - 验证 prompt 非空
  - 验证 aspectRatio 有效
  - 验证 model 有效
  - 在验证失败时抛出 `APIError` 并附带 `INVALID_PARAMS` 错误代码
  - _需求: 4.1, 4.5_

- [x] 9.1 编写参数验证的属性测试
  - **属性 5: API 参数验证**
  - **验证: 需求 4.1, 4.5**

- [x] 10. 增强 Upscaler Service
  - 修改 `services/hfService.ts` 中的 `upscaler` 函数
  - 集成 Token Manager 进行令牌轮询
  - 添加图像分辨率检测
  - 实现 4K 放大幂等性检查
  - 添加故障转移支持
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10.1 编写 4K 放大幂等性的属性测试
  - **属性 10: 4K 放大幂等性**
  - **验证: 需求 5.3**

- [x] 11. 创建令牌管理 UI 组件
  - 创建 `components/TokenManager.tsx` 组件
  - 实现令牌列表显示(部分隐藏令牌内容)
  - 实现添加令牌表单和验证
  - 实现删除令牌确认对话框
  - 实现编辑令牌功能
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 12. 创建令牌状态显示组件
  - 创建 `components/TokenStats.tsx` 组件
  - 显示每个令牌的使用次数
  - 显示每个令牌的成功/失败次数
  - 显示最后使用时间
  - 显示令牌状态(活跃、禁用、配额耗尽)
  - 显示禁用令牌的恢复时间
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 13. 集成令牌管理到设置界面
  - 修改 `components/SettingsModal.tsx`
  - 添加令牌管理选项卡
  - 集成 `TokenManager` 和 `TokenStats` 组件
  - 添加令牌轮询开关
  - 添加高级设置(重试次数、超时时间等)
  - _需求: 1.1, 6.1_

- [x] 14. 实现数据迁移逻辑
  - 创建 `utils/migration.ts` 文件
  - 检测旧的 `huggingFaceToken` localStorage 项
  - 自动迁移到新的令牌池格式
  - 在应用启动时执行迁移
  - 迁移后删除旧的存储项
  - _需求: 向后兼容性_

- [x] 15. 添加错误提示和用户反馈
  - 在 UI 中显示详细的错误信息
  - 当所有令牌失败时显示友好提示
  - 添加令牌验证失败的即时反馈
  - 添加令牌状态变化的通知
  - _需求: 3.3, 4.4_

- [x] 16. 实现配置管理
  - 创建 `utils/config.ts` 文件
  - 实现设置的加载和保存
  - 提供默认配置值
  - 实现配置验证
  - _需求: 7.1, 7.3_

- [x] 17. 添加性能优化
  - 实现 localStorage 写入节流(避免频繁 I/O)
  - 实现令牌验证结果缓存(5 分钟)
  - 添加并发请求控制(最多 3 个)
  - 优化令牌池查找性能
  - _需求: 性能考虑_

- [x] 18. 更新类型定义
  - 更新 `types.ts` 文件
  - 添加新的错误类型
  - 更新 `GeneratedImage` 接口支持令牌信息
  - 确保类型安全
  - _需求: 所有_

- [x] 19. 添加日志和监控
  - 实现简单的日志系统
  - 记录令牌使用情况
  - 记录 API 调用性能
  - 记录错误和重试事件
  - _需求: 6.1, 7.5_

- [x] 20. 更新文档和示例
  - 更新 README.md 说明新功能
  - 添加令牌管理使用指南
  - 添加故障排除部分
  - 更新配置说明
  - _需求: 所有_

- [x] 21. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过,如有问题请询问用户
